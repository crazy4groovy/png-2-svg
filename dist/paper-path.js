"use strict";const paper=require("paper-jsdom"),{CompoundPath:CompoundPath,Point:Point,Size:Size}=paper;paper.setup(new Size(999,999));const groupByTwo=(e,n,o,r)=>(o%2==1&&e.push([Number(r[o-1]),Number(r[o])]),e);function handleLineBy(e,n){const o=n.reduce(groupByTwo,[]);if(e.closed){const[n,r]=o.shift();e.moveTo(new Point(n,r))}o.forEach(([n,o])=>e.lineBy(new Point(n,o)))}function handleLineTo(e,n){const o=n.reduce(groupByTwo,[]);if(e.closed){const[n,r]=o.shift();e.moveTo(new Point(n,r))}o.forEach(([n,o])=>e.lineTo(new Point(n,o)))}function handleCubicBy(e,n){const o=n.reduce(groupByTwo,[]).pop(),[r,t]=o;e.cubicCurveBy(new Point(r,t))}function handleQuadraticTo(e,n){const o=n.reduce(groupByTwo,[]).pop(),[r,t]=o;e.quadraticCurveTo(new Point(r,t))}function handleQuadraticBy(e,n){const o=n.reduce(groupByTwo,[]).pop(),[r,t]=o;e.quadraticCurveBy(new Point(r,t))}function handleArcBy(e,n){const o=n.reduce(groupByTwo,[]).pop(),[r,t]=o;e.arcBy(new Point(r,t))}function handleArcTo(e,n){const o=n.reduce(groupByTwo,[]).pop(),[r,t]=o;e.arcTo(new Point(r,t))}function handleMoveBy(e,n){const o=n.reduce(groupByTwo,[]).pop(),[r,t]=o;e.moveBy(new Point(r,t))}function handleMoveTo(e,n){const o=n.reduce(groupByTwo,[]).pop(),[r,t]=o;e.moveTo(new Point(r,t))}const handleCommand=e=>n=>{const o=n[0];let r=n.substr(1).match(/-?\d+ */g);switch(r&&(r=r.map(e=>e.trim())),o){case"L":return handleLineTo(e,r);case"l":return handleLineBy(e,r);case"H":return handleLineTo(e,[r[0],0]);case"h":return handleLineBy(e,[r[0],0]);case"V":return handleLineTo(e,[0,r[0]]);case"v":return handleLineBy(e,[0,r[0]]);case"c":return handleCubicBy(e,r);case"Q":return handleQuadraticTo(e,r);case"q":return handleQuadraticBy(e,r);case"t":return handleArcBy(e,r);case"T":return handleArcTo(e,r);case"m":return handleMoveBy(e,r);case"M":return handleMoveTo(e,r);case"z":return e.closePath();default:throw new Error(o+" is UNKNOWN COMMAND")}},lineReducer=e=>n=>n.reduce((n,o)=>{const r=o[0];return"l"!==r&&e.length>1&&(n.push(e),e="l"),"l"===r?e+=" "+o.substr(1):n.push(o),n},[]);function optimizePath(e,{tolerance:n=10,type:o="continuous",factor:r=.2,precision:t=0}={}){let c=e.slice(3,-1).match(/[a-z][^a-z]*/gi);c=lineReducer("l")(c);const a=new CompoundPath;if(c.forEach(handleCommand(a)),a.children.forEach(e=>e.reduce()),n&&a.children.forEach(e=>e.simplify(n)),o&&r)try{a.children.forEach(e=>e.smooth({type:o,factor:r}))}catch(e){if("Cannot read property '_x' of undefined"!==e.message)throw e}return(a.exportSVG({asString:!0,precision:t}).match(/d="[^"]*"/g)||['d=""'])[0]}module.exports=optimizePath;
